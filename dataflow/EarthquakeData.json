{
	"name": "EarthquakeData",
	"properties": {
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"linkedService": {
						"referenceName": "Earthquakes",
						"type": "LinkedServiceReference"
					},
					"name": "Earthquakes",
					"description": "Earthquake data from USGS"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "earthquake",
						"type": "DatasetReference"
					},
					"name": "EarthquakeDest",
					"description": "Export data to earthquake table"
				},
				{
					"dataset": {
						"referenceName": "earthquake_run_log",
						"type": "DatasetReference"
					},
					"name": "Log"
				}
			],
			"transformations": [
				{
					"name": "ParseJSON"
				},
				{
					"name": "CountRows"
				},
				{
					"name": "AddParameterValues"
				}
			],
			"scriptLines": [
				"parameters{",
				"     starttime as string (toString(addDays(currentUTC(),-1),'yyyy-MM-dd')),",
				"     endtime as string (toString(currentUTC(),'yyyy-MM-dd'))",
				"}",
				"source(output(",
				"          body as (bbox as double[], features as (geometry as (coordinates as double[], type as string), id as string, properties as (alert as string, cdi as double, code as string, detail as string, dmin as double, felt as short, gap as short, ids as string, mag as double, magType as string, mmi as double, net as string, nst as short, place as string, rms as double, sig as short, sources as string, status as string, time as long, title as string, tsunami as boolean, type as string, types as string, tz as string, updated as long, url as string), type as string)[], metadata as (api as string, count as short, generated as long, status as short, title as string, url as string), type as string),",
				"          headers as [string,string]",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: true,",
				"     format: 'rest',",
				"     timeout: 30,",
				"     requestInterval: 0,",
				"     entity: 'https://earthquake.usgs.gov/fdsnws/event/1/query',",
				"     queryParameters: ['format' -> 'geojson', 'starttime' -> ($starttime), 'endtime' -> ($endtime)],",
				"     httpMethod: 'GET',",
				"     paginationRules: ['supportRFC5988' -> 'true'],",
				"     responseFormat: ['type' -> 'json', 'documentForm' -> 'arrayOfDocuments']) ~> Earthquakes",
				"Earthquakes foldDown(unroll(body.features),",
				"     mapColumn(",
				"          mag = body.features.properties.mag,",
				"          place = body.features.properties.place,",
				"          time = body.features.properties.time,",
				"          updated = body.features.properties.updated,",
				"          tz = body.features.properties.tz,",
				"          url = body.features.properties.url,",
				"          detail = body.features.properties.detail,",
				"          felt = body.features.properties.felt,",
				"          cdi = body.features.properties.cdi,",
				"          mmi = body.features.properties.mmi,",
				"          alert = body.features.properties.alert,",
				"          status = body.features.properties.status,",
				"          tsunami = body.features.properties.tsunami,",
				"          sig = body.features.properties.sig,",
				"          net = body.features.properties.net,",
				"          code = body.features.properties.code,",
				"          ids = body.features.properties.ids,",
				"          sources = body.features.properties.sources,",
				"          types = body.features.properties.types,",
				"          nst = body.features.properties.nst,",
				"          dmin = body.features.properties.dmin,",
				"          rms = body.features.properties.rms,",
				"          gap = body.features.properties.gap,",
				"          magType = body.features.properties.magType,",
				"          type = body.features.geometry.type,",
				"          title = body.features.properties.title",
				"     ),",
				"     skipDuplicateMapInputs: false,",
				"     skipDuplicateMapOutputs: false) ~> ParseJSON",
				"ParseJSON aggregate(rowcount = count(time)) ~> CountRows",
				"CountRows derive(starttime = $starttime,",
				"          endtime = $endtime) ~> AddParameterValues",
				"ParseJSON sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     input(",
				"          mag as double,",
				"          place as string,",
				"          time as long,",
				"          updated as long,",
				"          tz as string,",
				"          url as string,",
				"          detail as string,",
				"          felt as integer,",
				"          cdi as double,",
				"          mmi as double,",
				"          alert as string,",
				"          status as string,",
				"          tsunami as boolean,",
				"          sig as integer,",
				"          net as string,",
				"          code as string,",
				"          ids as string,",
				"          sources as string,",
				"          types as string,",
				"          nst as integer,",
				"          dmin as double,",
				"          rms as double,",
				"          gap as integer,",
				"          magType as string,",
				"          type as string,",
				"          title as string",
				"     ),",
				"     deletable:false,",
				"     insertable:true,",
				"     updateable:false,",
				"     upsertable:false,",
				"     format: 'table',",
				"     preSQLs:[(\"DELETE FROM dbo.earthquake WHERE dateadd(ms, time, '1970-01-01T00:00:00.000Z') BETWEEN '{$starttime}' AND '{$endtime}' \")],",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true,",
				"     errorHandlingOption: 'stopOnFirstError',",
				"     mapColumn(",
				"          mag,",
				"          place,",
				"          time,",
				"          updated,",
				"          tz,",
				"          url,",
				"          detail,",
				"          felt,",
				"          cdi,",
				"          mmi,",
				"          alert,",
				"          status,",
				"          tsunami,",
				"          sig,",
				"          net,",
				"          code,",
				"          ids,",
				"          sources,",
				"          types,",
				"          nst,",
				"          dmin,",
				"          rms,",
				"          gap,",
				"          magType,",
				"          type,",
				"          title",
				"     )) ~> EarthquakeDest",
				"AddParameterValues sink(allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     input(",
				"          runDate as timestamp,",
				"          starttime as string,",
				"          endtime as string,",
				"          rows as integer",
				"     ),",
				"     deletable:false,",
				"     insertable:true,",
				"     updateable:false,",
				"     upsertable:false,",
				"     format: 'table',",
				"     skipDuplicateMapInputs: true,",
				"     skipDuplicateMapOutputs: true,",
				"     errorHandlingOption: 'stopOnFirstError',",
				"     mapColumn(",
				"          starttime,",
				"          endtime,",
				"          rows = rowcount",
				"     )) ~> Log"
			]
		}
	}
}